---
# https://access.redhat.com/solutions/5034771
- name: add infrastructure role label to infra nodes
  environment:
    KUBECONFIG: "{{ openshift_kubeconfig_file }}"
    LABEL: "{{ infranodes_label|quote }}"
  ansible.builtin.shell:
    cmd:
      # yamllint disable-line rule:line-length
      kubectl --insecure-skip-tls-verify label nodes $(kubectl --insecure-skip-tls-verify get nodes --no-headers -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}'| grep infra) ${LABEL}=""
  register: infranodes_labeloutput
  changed_when: '"already has a value" not in infranodes_labeloutput.stdout'
  failed_when: '"error" in infranodes_labeloutput.stdout'
  tags:
    - infranodes
    - infranodes.ocp
    - infranodes.label

- name: add app role label to worker nodes
  environment:
    KUBECONFIG: "{{ openshift_kubeconfig_file }}"
    LABEL: "{{ infranodes_app_label }}"
  ansible.builtin.shell:
    # yamllint disable-line rule:line-length
    cmd: kubectl --insecure-skip-tls-verify label nodes $(kubectl --insecure-skip-tls-verify get nodes --no-headers -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}'| grep worker) "${LABEL}"=""
  register: infranodes_app
  changed_when: '"already has a value" not in infranodes_app.stdout'
  failed_when: '"error" in infranodes_app.stdout'

- name: "Annotate namespaces with daemonsets correctly"
  environment:
    KUBECONFIG: "{{ openshift_kubeconfig_file }}"
  ansible.builtin.command:
    # yamllint disable-line rule:line-length
    cmd: "kubectl --insecure-skip-tls-verify annotate ns {{ infranodes_namespace }} openshift.io/node-selector="
  register: infranodes_annotate
  loop: "{{ infranodes_daemonset_namespaces }}"
  loop_control:
    loop_var: infranodes_namespace
  changed_when: '"openshift-logging annotated" in infranodes_annotate.stdout'
  failed_when: '"error" in infranodes_annotate.stdout'
  tags:
    - infranodes
    - infranodes.ocp
    - infranodes.logging
    - molecule-notest
...
